<!--
  Project Artemis Sysmon Configuration
  
  Based on SwiftOnSecurity's sysmon-config with additions for:
  - Enhanced process monitoring
  - Network connection tracking
  - File integrity monitoring
  - Registry persistence detection
  
  Install Sysmon:
    1. Download from https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon
    2. Run: sysmon64.exe -accepteula -i sysmon-config.xml
    
  Update config:
    sysmon64.exe -c sysmon-config.xml
-->
<Sysmon schemaversion="4.90">
  <HashAlgorithms>md5,sha256,IMPHASH</HashAlgorithms>
  <CheckRevocation>False</CheckRevocation>
  
  <EventFiltering>
    
    <!-- Event ID 1: Process Create -->
    <RuleGroup name="ProcessCreate" groupRelation="or">
      <ProcessCreate onmatch="exclude">
        <!-- Exclude noisy Windows processes -->
        <Image condition="is">C:\Windows\System32\backgroundTaskHost.exe</Image>
        <Image condition="is">C:\Windows\System32\RuntimeBroker.exe</Image>
        <Image condition="is">C:\Windows\System32\SearchProtocolHost.exe</Image>
        <Image condition="is">C:\Windows\System32\SearchFilterHost.exe</Image>
        <Image condition="is">C:\Windows\System32\audiodg.exe</Image>
        <Image condition="is">C:\Windows\System32\conhost.exe</Image>
        <!-- Add more exclusions as needed for your environment -->
      </ProcessCreate>
    </RuleGroup>

    <!-- Event ID 3: Network Connection -->
    <RuleGroup name="NetworkConnect" groupRelation="or">
      <NetworkConnect onmatch="include">
        <!-- Log all outbound connections except localhost -->
        <Initiated condition="is">true</Initiated>
      </NetworkConnect>
      <NetworkConnect onmatch="exclude">
        <DestinationIp condition="is">127.0.0.1</DestinationIp>
        <DestinationIp condition="begin with">192.168.</DestinationIp>
        <DestinationIp condition="begin with">10.</DestinationIp>
        <DestinationIp condition="begin with">172.16.</DestinationIp>
        <!-- Common safe destinations -->
        <DestinationHostname condition="end with">.microsoft.com</DestinationHostname>
        <DestinationHostname condition="end with">.windows.com</DestinationHostname>
        <DestinationHostname condition="end with">.windowsupdate.com</DestinationHostname>
      </NetworkConnect>
    </RuleGroup>

    <!-- Event ID 5: Process Terminate -->
    <RuleGroup name="ProcessTerminate" groupRelation="or">
      <ProcessTerminate onmatch="include">
        <!-- Log termination of security-relevant processes -->
        <Image condition="contains any">powershell;cmd;wscript;cscript;mshta</Image>
      </ProcessTerminate>
    </RuleGroup>

    <!-- Event ID 7: Image Load (DLL) -->
    <RuleGroup name="ImageLoad" groupRelation="or">
      <ImageLoad onmatch="include">
        <!-- Log suspicious DLL loads -->
        <ImageLoaded condition="contains">\Temp\</ImageLoaded>
        <ImageLoaded condition="contains">\Downloads\</ImageLoaded>
        <ImageLoaded condition="contains">\Users\Public\</ImageLoaded>
        <Signed condition="is">false</Signed>
      </ImageLoad>
    </RuleGroup>

    <!-- Event ID 8: CreateRemoteThread -->
    <RuleGroup name="CreateRemoteThread" groupRelation="or">
      <CreateRemoteThread onmatch="exclude">
        <!-- Exclude known legitimate -->
        <SourceImage condition="is">C:\Windows\System32\csrss.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\System32\wininit.exe</SourceImage>
        <SourceImage condition="is">C:\Windows\System32\lsass.exe</SourceImage>
      </CreateRemoteThread>
    </RuleGroup>

    <!-- Event ID 10: ProcessAccess -->
    <RuleGroup name="ProcessAccess" groupRelation="or">
      <ProcessAccess onmatch="include">
        <!-- Log access to sensitive processes -->
        <TargetImage condition="is">C:\Windows\System32\lsass.exe</TargetImage>
        <TargetImage condition="is">C:\Windows\System32\csrss.exe</TargetImage>
        <TargetImage condition="is">C:\Windows\System32\winlogon.exe</TargetImage>
      </ProcessAccess>
    </RuleGroup>

    <!-- Event ID 11: FileCreate -->
    <RuleGroup name="FileCreate" groupRelation="or">
      <FileCreate onmatch="include">
        <!-- Log executable creation in suspicious locations -->
        <TargetFilename condition="contains">\Temp\</TargetFilename>
        <TargetFilename condition="contains">\Downloads\</TargetFilename>
        <TargetFilename condition="contains">\Users\Public\</TargetFilename>
        <TargetFilename condition="contains">\ProgramData\</TargetFilename>
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.ps1</TargetFilename>
        <TargetFilename condition="end with">.bat</TargetFilename>
        <TargetFilename condition="end with">.cmd</TargetFilename>
        <TargetFilename condition="end with">.vbs</TargetFilename>
        <TargetFilename condition="end with">.js</TargetFilename>
        <TargetFilename condition="end with">.hta</TargetFilename>
      </FileCreate>
    </RuleGroup>

    <!-- Event ID 12,13,14: Registry Events -->
    <RuleGroup name="RegistryEvent" groupRelation="or">
      <RegistryEvent onmatch="include">
        <!-- Persistence locations -->
        <TargetObject condition="contains">CurrentVersion\Run</TargetObject>
        <TargetObject condition="contains">CurrentVersion\RunOnce</TargetObject>
        <TargetObject condition="contains">CurrentVersion\Policies\Explorer\Run</TargetObject>
        <TargetObject condition="contains">Winlogon</TargetObject>
        <TargetObject condition="contains">\Services\</TargetObject>
        <!-- Security settings -->
        <TargetObject condition="contains">Windows Defender</TargetObject>
        <TargetObject condition="contains">DisableAntiSpyware</TargetObject>
        <TargetObject condition="contains">DisableAntiVirus</TargetObject>
      </RegistryEvent>
    </RuleGroup>

    <!-- Event ID 17,18: Pipe Events -->
    <RuleGroup name="PipeEvent" groupRelation="or">
      <PipeEvent onmatch="include">
        <!-- Log named pipes used by malware -->
        <PipeName condition="contains">mimikatz</PipeName>
        <PipeName condition="contains">cobaltstrike</PipeName>
        <PipeName condition="begin with">\</PipeName>
      </PipeEvent>
    </RuleGroup>

    <!-- Event ID 22: DNS Query -->
    <RuleGroup name="DnsQuery" groupRelation="or">
      <DnsQuery onmatch="exclude">
        <!-- Exclude known safe queries -->
        <QueryName condition="end with">.microsoft.com</QueryName>
        <QueryName condition="end with">.windows.com</QueryName>
        <QueryName condition="end with">.windowsupdate.com</QueryName>
        <QueryName condition="end with">.bing.com</QueryName>
        <QueryName condition="end with">.msftncsi.com</QueryName>
        <QueryName condition="is">localhost</QueryName>
      </DnsQuery>
    </RuleGroup>

    <!-- Event ID 23: File Delete (archived) -->
    <RuleGroup name="FileDelete" groupRelation="or">
      <FileDelete onmatch="include">
        <!-- Log deletion of security-relevant files -->
        <TargetFilename condition="end with">.exe</TargetFilename>
        <TargetFilename condition="end with">.dll</TargetFilename>
        <TargetFilename condition="end with">.evtx</TargetFilename>
        <TargetFilename condition="contains">\Windows\System32\</TargetFilename>
      </FileDelete>
    </RuleGroup>

    <!-- Event ID 25: Process Tampering -->
    <RuleGroup name="ProcessTampering" groupRelation="or">
      <ProcessTampering onmatch="include">
        <!-- Log all process tampering -->
      </ProcessTampering>
    </RuleGroup>

  </EventFiltering>
</Sysmon>
