<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Artemis | Security Operations Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Artemis Amber/Black Theme */
            --bg-primary: #050505;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --bg-card: #0d0d0d;
            --bg-hover: #151515;
            --border: #1a1a1a;
            --border-light: #252525;
            --text-primary: #f5f5f5;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            
            /* Amber/Orange Accent */
            --accent: #f59e0b;
            --accent-bright: #fbbf24;
            --accent-dim: #d97706;
            --accent-glow: rgba(245, 158, 11, 0.15);
            
            /* Status Colors */
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --critical: #dc2626;
            --info: #3b82f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Layout */
        .app { display: flex; height: 100vh; }
        
        .sidebar {
            width: 200px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 1.5rem 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(180deg, rgba(245, 158, 11, 0.12) 0%, rgba(245, 158, 11, 0.03) 60%, transparent 100%);
        }

        .logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
        }

        .logo-img {
            width: 140px;
            height: 140px;
            object-fit: contain;
            filter: drop-shadow(0 0 30px rgba(245, 158, 11, 0.5)) drop-shadow(0 0 60px rgba(245, 158, 11, 0.25));
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--accent);
            letter-spacing: 0.2em;
            text-shadow: 0 0 30px rgba(245, 158, 11, 0.6);
            margin-top: -0.25rem;
        }

        .nav-section {
            padding: 0.75rem 0.5rem;
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.7rem 1rem;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
            margin-bottom: 0.125rem;
            user-select: none;
            font-size: 0.9rem;
        }

        .nav-item:hover { 
            background: var(--bg-hover); 
            color: var(--text-primary); 
        }
        
        .nav-item.active { 
            background: var(--accent); 
            color: #000; 
            font-weight: 600; 
        }

        .nav-icon { 
            width: 20px; 
            text-align: center; 
            font-size: 0.95rem;
            opacity: 0.9;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .header {
            padding: 0.875rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title { 
            font-size: 1.1rem; 
            font-weight: 600; 
            color: var(--text-primary);
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 1.25rem;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.875rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background: var(--success); }
        .status-dot.warning { background: var(--warning); }
        .status-dot.danger { background: var(--danger); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Views Container */
        .views-container {
            flex: 1;
            overflow: hidden;
        }

        .view {
            display: none;
            height: 100%;
            overflow: auto;
            padding: 1rem;
        }

        .view.active { display: block; }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 340px;
            grid-template-rows: auto 1fr auto;
            gap: 1rem;
            height: 100%;
        }

        /* Stats Row */
        .stats-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 0.875rem;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem 1rem;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.375rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.accent { color: var(--accent); }
        .stat-value.success { color: var(--success); }
        .stat-value.warning { color: var(--warning); }
        .stat-value.danger { color: var(--danger); }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .card-body {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        /* Network Map */
        .network-map { grid-row: 2; }
        
        .map-container {
            height: 100%;
            min-height: 350px;
            position: relative;
            background: 
                radial-gradient(circle at 50% 50%, var(--accent-glow) 0%, transparent 50%),
                linear-gradient(90deg, var(--border) 1px, transparent 1px) 0 0 / 30px 30px,
                linear-gradient(var(--border) 1px, transparent 1px) 0 0 / 30px 30px;
        }

        #topology { width: 100%; height: 100%; }

        /* Device List */
        .device-item {
            padding: 0.625rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .device-item:hover {
            background: var(--bg-hover);
            border-color: var(--border);
        }

        .device-item.selected {
            background: var(--bg-tertiary);
            border-color: var(--accent);
        }

        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.25rem;
        }

        .device-name {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .device-type-badge {
            font-size: 0.6rem;
            padding: 0.125rem 0.4rem;
            border-radius: 3px;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .device-type-badge.desktop { background: rgba(59, 130, 246, 0.15); color: var(--info); }
        .device-type-badge.server { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
        .device-type-badge.router { background: var(--accent-glow); color: var(--accent); }
        .device-type-badge.mobile { background: rgba(236, 72, 153, 0.15); color: #ec4899; }

        .device-ip {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .device-stats {
            display: flex;
            gap: 1rem;
            margin-top: 0.375rem;
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        /* Sidebar Panels */
        .sidebar-panel {
            grid-row: 2;
            display: flex;
            flex-direction: column;
            gap: 0.875rem;
        }

        /* Threat Panel */
        .threat-item {
            padding: 0.625rem;
            border-left: 3px solid var(--danger);
            background: rgba(239, 68, 68, 0.08);
            margin: 0.375rem;
            border-radius: 0 6px 6px 0;
        }

        .threat-item.critical { border-color: var(--critical); background: rgba(220, 38, 38, 0.12); }
        .threat-item.high { border-color: var(--danger); }
        .threat-item.medium { border-color: var(--warning); background: rgba(245, 158, 11, 0.08); }
        .threat-item.low { border-color: var(--info); background: rgba(59, 130, 246, 0.08); }

        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.375rem;
        }

        .threat-title { font-weight: 600; font-size: 0.85rem; }

        .threat-badge {
            font-size: 0.6rem;
            padding: 0.125rem 0.4rem;
            border-radius: 3px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .threat-badge.critical { background: var(--critical); color: white; }
        .threat-badge.high { background: var(--danger); color: white; }
        .threat-badge.medium { background: var(--warning); color: black; }
        .threat-badge.low { background: var(--info); color: white; }

        .threat-description {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.375rem;
        }

        /* Buttons */
        .btn {
            padding: 0.45rem 0.875rem;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.15s;
        }

        .btn-primary { background: var(--accent); color: #000; }
        .btn-primary:hover { background: var(--accent-bright); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { 
            background: var(--bg-tertiary); 
            color: var(--text-primary); 
            border: 1px solid var(--border); 
        }
        .btn-secondary:hover { background: var(--bg-hover); border-color: var(--border-light); }

        /* Bottom Bar */
        .bottom-bar {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.875rem;
        }

        /* Connection Table */
        .conn-row {
            display: grid;
            grid-template-columns: 110px 1fr 80px 70px;
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid var(--border);
            align-items: center;
            font-size: 0.75rem;
        }

        .conn-row:hover { background: var(--bg-hover); }
        .conn-process { color: var(--accent); font-weight: 500; }
        .conn-remote { color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; }
        .conn-port { color: var(--accent-dim); font-family: 'JetBrains Mono', monospace; }
        
        .conn-state {
            font-size: 0.65rem;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            text-align: center;
        }
        
        .conn-state.established { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .conn-state.listen { background: rgba(59, 130, 246, 0.15); color: var(--info); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title { font-size: 1.1rem; font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0.25rem;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body {
            padding: 1.25rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.375rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border);
            padding-bottom: 0.5rem;
        }

        .tab {
            padding: 0.45rem 0.875rem;
            border-radius: 5px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s;
            user-select: none;
            font-size: 0.85rem;
        }

        .tab:hover { color: var(--text-primary); background: var(--bg-hover); }
        .tab.active { background: var(--accent); color: #000; font-weight: 500; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Telemetry Display */
        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.875rem;
        }

        .telemetry-card {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 0.875rem;
        }

        .telemetry-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.375rem;
        }

        .telemetry-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
        }

        /* AI Analysis Panel */
        .ai-panel {
            background: var(--accent-glow);
            border: 1px solid var(--accent-dim);
            border-radius: 6px;
            padding: 0.875rem;
            margin-top: 0.875rem;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            margin-bottom: 0.375rem;
            color: var(--accent);
        }

        .ai-response {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-icon { 
            font-size: 1.5rem; 
            margin-bottom: 0.5rem; 
            opacity: 0.4; 
        }

        /* Live indicator */
        .live-badge {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.7rem;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        /* View-specific styles */
        .view-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
        }

        .view-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .view-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 0.625rem 0.875rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-tertiary);
            font-weight: 600;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .data-table tr:hover { background: var(--bg-hover); }

        /* Grid layout for devices view */
        .devices-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 0.875rem;
        }

        .device-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .device-card:hover {
            border-color: var(--accent);
            transform: translateY(-1px);
        }

        /* Form Elements */
        .form-group { margin-bottom: 0.875rem; }

        .form-label {
            display: block;
            margin-bottom: 0.375rem;
            font-weight: 500;
            font-size: 0.8rem;
        }

        .form-input {
            width: 100%;
            padding: 0.625rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 5px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-light); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Tool badge */
        .tool-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            border: 1px solid var(--border);
        }
        .tool-badge.available {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--success);
            color: var(--success);
        }
        .tool-badge.missing {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        /* Debug log styles */
        .debug-log {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: #050505;
            color: var(--text-muted);
            padding: 0.625rem;
            height: 320px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-phase { color: var(--accent); }
        .log-agent { color: #22d3ee; }
        .log-llm { color: #a855f7; }
        .log-http { color: var(--info); }
        .log-vuln { color: var(--danger); }
        .log-success { color: var(--success); }
        .log-error { color: var(--danger); }
        .log-warn { color: var(--warning); }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="/static/images/Logo_Only.png" alt="Artemis" class="logo-img">
                    <span class="logo-text">ARTEMIS</span>
                </div>
            </div>
            <nav class="nav-section" id="mainNav">
                <div class="nav-item active" data-view="dashboard">
                    <span class="nav-icon">~</span>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" data-view="devices">
                    <span class="nav-icon">#</span>
                    <span>Endpoints</span>
                </div>
                <div class="nav-item" data-view="network">
                    <span class="nav-icon">@</span>
                    <span>Network</span>
                </div>
                <div class="nav-item" data-view="threats">
                    <span class="nav-icon">!</span>
                    <span>Threats</span>
                </div>
                <div class="nav-item" data-view="scan">
                    <span class="nav-icon">?</span>
                    <span>Scanner</span>
                </div>
                <div class="nav-item" data-view="remediation">
                    <span class="nav-icon">+</span>
                    <span>Remediation</span>
                </div>
                <div class="nav-item" data-view="pentest">
                    <span class="nav-icon">*</span>
                    <span>Pentest</span>
                </div>
                <div class="nav-item" data-view="rules">
                    <span class="nav-icon">=</span>
                    <span>Rules</span>
                </div>
                <div class="nav-item" data-view="settings">
                    <span class="nav-icon">%</span>
                    <span>Settings</span>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 class="header-title" id="pageTitle">Security Operations Center</h1>
                <div class="header-status">
                    <div class="status-badge">
                        <span class="status-dot online" id="agentDot"></span>
                        <span id="agentStatusText">Monitoring</span>
                    </div>
                    <div class="status-badge">
                        <span>AI:</span>
                        <strong id="modelName">deepseek-r1:70b</strong>
                    </div>
                    <div class="live-badge">
                        <span class="live-dot"></span>
                        LIVE
                    </div>
                </div>
            </header>

            <div class="views-container">
                <!-- Dashboard View -->
                <div class="view active" id="view-dashboard">
                    <div class="dashboard-grid">
                        <!-- Stats Row -->
                        <div class="stats-row">
                            <div class="stat-card">
                                <div class="stat-label">Endpoints</div>
                                <div class="stat-value accent" id="statDevices">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Connections</div>
                                <div class="stat-value" id="statConnections">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Traffic In</div>
                                <div class="stat-value success" id="statTrafficIn">0 B</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Traffic Out</div>
                                <div class="stat-value warning" id="statTrafficOut">0 B</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Threats</div>
                                <div class="stat-value danger" id="statThreats">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">AI Analyses</div>
                                <div class="stat-value" id="statAnalyses">0</div>
                            </div>
                        </div>

                        <!-- Network Map -->
                        <div class="card network-map">
                            <div class="card-header">
                                <span>Network Topology</span>
                                <button class="btn btn-secondary" onclick="refreshTopology()">Refresh</button>
                            </div>
                            <div class="card-body map-container">
                                <canvas id="topology"></canvas>
                            </div>
                        </div>

                        <!-- Sidebar Panels -->
                        <div class="sidebar-panel">
                            <div class="card" style="flex: 1;">
                                <div class="card-header">
                                    <span>Endpoints</span>
                                    <span id="deviceCountBadge">0</span>
                                </div>
                                <div class="card-body" id="devicesList">
                                    <div class="empty-state">
                                        <div class="empty-icon">[...]</div>
                                        <div>Scanning network...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="max-height: 260px;">
                                <div class="card-header">
                                    <span>Active Threats</span>
                                    <span id="threatCountBadge">0</span>
                                </div>
                                <div class="card-body" id="threatsList">
                                    <div class="empty-state">
                                        <div class="empty-icon">[OK]</div>
                                        <div>No active threats</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bottom Panels -->
                        <div class="bottom-bar">
                            <div class="card" style="max-height: 180px;">
                                <div class="card-header">
                                    <span>Active Connections</span>
                                    <span class="live-badge"><span class="live-dot"></span></span>
                                </div>
                                <div class="card-body" id="connectionsList">
                                    <div class="empty-state">
                                        <div class="empty-icon">[~]</div>
                                        <div>Monitoring...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="card" style="max-height: 180px;">
                                <div class="card-header">
                                    <span>AI Analysis Feed</span>
                                    <span class="live-badge"><span class="live-dot"></span></span>
                                </div>
                                <div class="card-body" id="aiList">
                                    <div class="empty-state">
                                        <div class="empty-icon">[AI]</div>
                                        <div>AI monitoring active</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Devices View -->
                <div class="view" id="view-devices">
                    <div class="view-header">
                        <h2 class="view-title">Endpoints</h2>
                        <div class="view-actions">
                            <button class="btn btn-secondary" onclick="scanNetwork()">Scan Network</button>
                            <button class="btn btn-primary" onclick="exportDevices()">Export</button>
                        </div>
                    </div>
                    <div class="devices-grid" id="devicesGrid">
                        <div class="empty-state">
                            <div class="empty-icon">[#]</div>
                            <div>No endpoints discovered yet</div>
                        </div>
                    </div>
                </div>

                <!-- Network View -->
                <div class="view" id="view-network">
                    <div class="view-header">
                        <h2 class="view-title">Network Traffic</h2>
                        <div class="view-actions">
                            <button class="btn btn-secondary" onclick="clearConnections()">Clear</button>
                            <button class="btn btn-primary" onclick="exportTraffic()">Export</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span>Active Connections</span>
                            <span class="live-badge"><span class="live-dot"></span> Live</span>
                        </div>
                        <div class="card-body" style="max-height: calc(100vh - 260px);">
                            <table class="data-table" id="connectionsTable">
                                <thead>
                                    <tr>
                                        <th>Process</th>
                                        <th>Local</th>
                                        <th>Remote</th>
                                        <th>State</th>
                                        <th>Protocol</th>
                                    </tr>
                                </thead>
                                <tbody id="connectionsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Threats View -->
                <div class="view" id="view-threats">
                    <div class="view-header">
                        <h2 class="view-title">Threat Detection</h2>
                        <div class="view-actions">
                            <button class="btn btn-secondary" onclick="dismissAllThreats()">Dismiss All</button>
                            <button class="btn btn-danger" onclick="remediateAll()">Remediate All</button>
                        </div>
                    </div>
                    <div id="threatsFullList">
                        <div class="empty-state">
                            <div class="empty-icon">[OK]</div>
                            <div>No active threats detected</div>
                            <p style="color: var(--text-muted); margin-top: 0.5rem;">AI monitoring is active</p>
                        </div>
                    </div>
                </div>

                <!-- File Scanner View -->
                <div class="view" id="view-scan">
                    <div class="view-header">
                        <h2 class="view-title">File Scanner</h2>
                        <div class="view-actions">
                            <button class="btn btn-primary" onclick="startScan()">Start Scan</button>
                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 0.875rem;">
                        <div class="card-header">Scan Configuration</div>
                        <div class="card-body" style="padding: 0.875rem;">
                            <div class="form-group">
                                <label class="form-label">Target Path</label>
                                <input type="text" class="form-input" id="scanPath" placeholder="C:\Users\...">
                            </div>
                            <div style="display: flex; gap: 1rem; font-size: 0.85rem;">
                                <label><input type="checkbox" id="scanDeep"> Deep Scan</label>
                                <label><input type="checkbox" id="scanAI" checked> AI Analysis</label>
                                <label><input type="checkbox" id="scanRecursive" checked> Recursive</label>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span>Scan Results</span>
                            <span id="scanStatus">Ready</span>
                        </div>
                        <div class="card-body" id="scanResults" style="min-height: 180px;">
                            <div class="empty-state">
                                <div class="empty-icon">[?]</div>
                                <div>Configure and start a scan</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Remediation View -->
                <div class="view" id="view-remediation">
                    <div class="view-header">
                        <h2 class="view-title">Remediation Center</h2>
                        <div class="view-actions">
                            <button class="btn btn-secondary" onclick="viewHistory()">History</button>
                            <button class="btn btn-secondary" onclick="rollbackLast()">Rollback Last</button>
                        </div>
                    </div>
                    <div class="ai-panel" style="margin-bottom: 0.875rem;">
                        <div class="ai-header">AI Remediation Assistant</div>
                        <div class="ai-response">
                            Double-scan verification ensures accurate threat identification before action. All remediation actions are logged and reversible.
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span>Pending Actions</span>
                            <span id="pendingActionsCount">0</span>
                        </div>
                        <div class="card-body" id="pendingActions" style="min-height: 180px;">
                            <div class="empty-state">
                                <div class="empty-icon">[OK]</div>
                                <div>No pending remediation actions</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pentest View -->
                <div class="view" id="view-pentest">
                    <div class="view-header">
                        <h2 class="view-title">Penetration Testing</h2>
                        <div class="view-actions">
                            <button class="btn btn-secondary" onclick="viewPentestHistory()">History</button>
                            <button class="btn btn-primary" onclick="showPentestModal()">New Pentest</button>
                        </div>
                    </div>
                    
                    <!-- Tools Status -->
                    <div class="card" style="margin-bottom: 0.875rem;">
                        <div class="card-header">
                            <span>Security Tools</span>
                            <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;" onclick="refreshToolsStatus()">Refresh</button>
                        </div>
                        <div class="card-body" style="padding: 0.625rem;">
                            <div id="toolsStatusGrid" style="display: flex; flex-wrap: wrap; gap: 0.375rem;">
                                <span style="color: var(--text-muted); font-size: 0.8rem;">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Pentest Status -->
                    <div class="card" style="margin-bottom: 0.875rem;">
                        <div class="card-header">
                            <span>Pentest Status</span>
                            <span class="status-badge" id="pentestStatusBadge">
                                <span class="status-dot"></span>
                                <span id="pentestStatusText">Idle</span>
                            </span>
                        </div>
                        <div class="card-body" style="padding: 0.875rem;">
                            <div id="pentestIdleState">
                                <div class="empty-state">
                                    <div class="empty-icon">[*]</div>
                                    <div>No pentest running</div>
                                    <button class="btn btn-primary" style="margin-top: 0.875rem;" onclick="showPentestModal()">Start Pentest</button>
                                </div>
                            </div>
                            <div id="pentestRunningState" style="display: none;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.875rem; margin-bottom: 0.875rem;">
                                    <div class="stat-card">
                                        <div class="stat-label">Target</div>
                                        <div class="stat-value" id="pentestTarget" style="font-size: 0.85rem;">-</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Progress</div>
                                        <div class="stat-value accent" id="pentestProgress">0%</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-label">Vulnerabilities</div>
                                        <div class="stat-value danger" id="pentestVulnCount">0</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 0.875rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.375rem; font-size: 0.85rem;">
                                        <span id="pentestCurrentAgent">Starting...</span>
                                        <span id="pentestCurrentTask" style="color: var(--text-muted);"></span>
                                    </div>
                                    <div style="height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                                        <div id="pentestProgressBar" style="height: 100%; background: var(--accent); width: 0%; transition: width 0.3s;"></div>
                                    </div>
                                </div>
                                <div id="pentestAgentList" style="display: flex; flex-wrap: wrap; gap: 0.375rem;"></div>
                                <div style="margin-top: 0.875rem; text-align: right;">
                                    <button class="btn btn-danger" onclick="cancelPentest()">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vulnerabilities Found -->
                    <div class="card" style="margin-bottom: 0.875rem;">
                        <div class="card-header">
                            <span>Vulnerabilities Found</span>
                            <span id="pentestVulnBadge" style="background: var(--danger); color: white; padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.8rem;">0</span>
                        </div>
                        <div class="card-body" id="pentestVulnList" style="min-height: 140px; max-height: 230px;">
                            <div class="empty-state">
                                <div class="empty-icon">[OK]</div>
                                <div>No vulnerabilities found yet</div>
                            </div>
                        </div>
                    </div>

                    <!-- Debug Log -->
                    <div class="card">
                        <div class="card-header" style="cursor: pointer;" onclick="toggleDebugPanel()">
                            <span>Debug Log</span>
                            <div style="display: flex; align-items: center; gap: 0.625rem;">
                                <span class="live-badge" id="debugLiveBadge" style="display: none;"><span class="live-dot"></span> Live</span>
                                <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;" onclick="event.stopPropagation(); clearDebugLog()">Clear</button>
                                <button class="btn btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.7rem;" onclick="event.stopPropagation(); downloadDebugLog()">Export</button>
                                <span id="debugToggleIcon" style="font-size: 0.9rem;">[-]</span>
                            </div>
                        </div>
                        <div class="card-body" id="pentestDebugBody" style="padding: 0;">
                            <div id="pentestDebugLog" class="debug-log"><span style="color: var(--text-muted);">[Waiting for pentest...]</span></div>
                        </div>
                    </div>
                </div>

                <!-- Rules View -->
                <div class="view" id="view-rules">
                    <div class="view-header">
                        <h2 class="view-title">Detection Rules</h2>
                        <div class="view-actions">
                            <button class="btn btn-secondary" onclick="importRules()">Import</button>
                            <button class="btn btn-primary" onclick="generateRule()">Generate Rule</button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <span>Rule Library</span>
                            <select class="form-input" style="width: auto; padding: 0.2rem 0.5rem; font-size: 0.8rem;" id="ruleFormatFilter">
                                <option value="">All Formats</option>
                                <option value="sigma">Sigma</option>
                                <option value="yara">YARA</option>
                                <option value="splunk">Splunk</option>
                                <option value="kql">KQL</option>
                                <option value="snort">Snort</option>
                            </select>
                        </div>
                        <div class="card-body" id="rulesList" style="min-height: 280px;">
                            <div class="empty-state">
                                <div class="empty-icon">[=]</div>
                                <div>No rules loaded</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings View -->
                <div class="view" id="view-settings">
                    <div class="view-header">
                        <h2 class="view-title">Settings</h2>
                        <div class="view-actions">
                            <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 0.875rem;">
                        <div class="card-header">AI Configuration</div>
                        <div class="card-body" style="padding: 0.875rem;">
                            <div class="form-group">
                                <label class="form-label">AI Provider</label>
                                <select class="form-input" id="settingsProvider">
                                    <option value="ollama">Ollama (Local)</option>
                                    <option value="openai">OpenAI</option>
                                    <option value="anthropic">Anthropic</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Model</label>
                                <select class="form-input" id="settingsModel">
                                    <option value="deepseek-r1:70b" selected>deepseek-r1:70b</option>
                                    <option value="qwen3:32b">qwen3:32b</option>
                                    <option value="qwen3:14b">qwen3:14b</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card" style="margin-bottom: 0.875rem;">
                        <div class="card-header">Network Monitoring</div>
                        <div class="card-body" style="padding: 0.875rem;">
                            <div class="form-group">
                                <label class="form-label">Scan Interval (seconds)</label>
                                <input type="number" class="form-input" id="settingsScanInterval" value="60">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Network Range</label>
                                <input type="text" class="form-input" id="settingsNetworkRange" value="192.168.4.0/24">
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">Remediation</div>
                        <div class="card-body" style="padding: 0.875rem;">
                            <div style="display: flex; flex-direction: column; gap: 0.625rem; font-size: 0.875rem;">
                                <label><input type="checkbox" id="settingsAutoQuarantine"> Auto-quarantine high-severity threats</label>
                                <label><input type="checkbox" id="settingsDoubleVerify" checked> Double-scan verification</label>
                                <label><input type="checkbox" id="settingsRequireApproval" checked> Require approval for destructive actions</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Device Detail Modal -->
    <div class="modal-overlay" id="deviceModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalDeviceName">Device Details</h2>
                <button class="modal-close" onclick="closeModal()">x</button>
            </div>
            <div class="modal-body">
                <div class="tabs" id="deviceTabs">
                    <div class="tab active" data-tab="overview">Overview</div>
                    <div class="tab" data-tab="network">Network</div>
                    <div class="tab" data-tab="processes">Processes</div>
                    <div class="tab" data-tab="telemetry">Telemetry</div>
                    <div class="tab" data-tab="actions">Actions</div>
                </div>
                <div class="tab-content active" id="tab-overview">
                    <div class="telemetry-grid" id="deviceOverview"></div>
                </div>
                <div class="tab-content" id="tab-network">
                    <div id="deviceNetworkInfo"></div>
                </div>
                <div class="tab-content" id="tab-processes">
                    <div id="deviceProcessList"></div>
                </div>
                <div class="tab-content" id="tab-telemetry">
                    <div id="deviceTelemetry"></div>
                </div>
                <div class="tab-content" id="tab-actions">
                    <div id="deviceActions"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="analyzeDevice()">AI Analysis</button>
            </div>
        </div>
    </div>

    <!-- Pentest Modal -->
    <div class="modal-overlay" id="pentestModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">New Penetration Test</h2>
                <button class="modal-close" onclick="closePentestModal()">x</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Target URL</label>
                    <input type="text" class="form-input" id="pentestTargetUrl" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Scope</label>
                    <select class="form-input" id="pentestScope">
                        <option value="full">Full Assessment</option>
                        <option value="quick">Quick Scan</option>
                        <option value="recon">Recon Only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Options</label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; font-size: 0.875rem;">
                        <label><input type="checkbox" id="pentestTools" checked> Use external tools</label>
                        <label><input type="checkbox" id="pentestExploit"> Attempt exploitation</label>
                        <label><input type="checkbox" id="pentestReport" checked> Generate report</label>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePentestModal()">Cancel</button>
                <button class="btn btn-primary" onclick="startPentest()">Start Pentest</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let state = {
            devices: [],
            threats: [],
            connections: [],
            selectedDevice: null,
            pentestRunning: false,
            pentestSessionId: null,
            ws: null,
            debugExpanded: true,
            debugLogs: []
        };

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const view = item.dataset.view;
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                item.classList.add('active');
                document.getElementById(`view-${view}`).classList.add('active');
                
                const titles = {
                    dashboard: 'Security Operations Center',
                    devices: 'Endpoint Management',
                    network: 'Network Traffic',
                    threats: 'Threat Detection',
                    scan: 'File Scanner',
                    remediation: 'Remediation Center',
                    pentest: 'Penetration Testing',
                    rules: 'Detection Rules',
                    settings: 'Settings'
                };
                document.getElementById('pageTitle').textContent = titles[view] || view;
            });
        });

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                const parent = tab.closest('.modal-body') || document;
                parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');
            });
        });

        // WebSocket
        function connectWS() {
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            state.ws = new WebSocket(`${protocol}//${location.host}/ws/live`);
            
            state.ws.onopen = () => {
                console.log('WebSocket connected');
                document.getElementById('agentDot').className = 'status-dot online';
            };
            
            state.ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWSMessage(data);
            };
            
            state.ws.onclose = () => {
                document.getElementById('agentDot').className = 'status-dot warning';
                setTimeout(connectWS, 3000);
            };
        }

        function handleWSMessage(data) {
            switch(data.type) {
                case 'devices':
                    state.devices = data.devices || [];
                    updateDevicesList();
                    break;
                case 'connections':
                    state.connections = data.connections || [];
                    updateConnectionsList();
                    break;
                case 'threat':
                    state.threats.push(data.threat);
                    updateThreatsList();
                    break;
                case 'stats':
                    updateStats(data);
                    break;
                case 'pentest_log':
                    appendDebugLog(data.level, data.message);
                    break;
                case 'pentest_status':
                    updatePentestStatus(data);
                    break;
            }
        }

        function updateStats(data) {
            if (data.devices !== undefined) document.getElementById('statDevices').textContent = data.devices;
            if (data.connections !== undefined) document.getElementById('statConnections').textContent = data.connections;
            if (data.threats !== undefined) document.getElementById('statThreats').textContent = data.threats;
            if (data.analyses !== undefined) document.getElementById('statAnalyses').textContent = data.analyses;
        }

        function updateDevicesList() {
            const container = document.getElementById('devicesList');
            const countBadge = document.getElementById('deviceCountBadge');
            countBadge.textContent = state.devices.length;
            
            if (state.devices.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">[...]</div><div>Scanning network...</div></div>';
                return;
            }
            
            container.innerHTML = state.devices.map(device => `
                <div class="device-item" onclick="selectDevice('${device.ip}')">
                    <div class="device-header">
                        <span class="device-name">${device.hostname || device.ip}</span>
                        <span class="device-type-badge ${device.type || ''}">${device.type || 'unknown'}</span>
                    </div>
                    <div class="device-ip">${device.ip}</div>
                    <div class="device-stats">
                        <span>${device.mac || '-'}</span>
                        <span>${device.vendor || ''}</span>
                    </div>
                </div>
            `).join('');
        }

        function updateConnectionsList() {
            const container = document.getElementById('connectionsList');
            document.getElementById('statConnections').textContent = state.connections.length;
            
            if (state.connections.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">[~]</div><div>Monitoring...</div></div>';
                return;
            }
            
            container.innerHTML = state.connections.slice(0, 20).map(conn => `
                <div class="conn-row">
                    <span class="conn-process">${conn.process || '-'}</span>
                    <span class="conn-remote">${conn.remote || '-'}</span>
                    <span class="conn-port">${conn.port || '-'}</span>
                    <span class="conn-state ${conn.state?.toLowerCase() || ''}">${conn.state || '-'}</span>
                </div>
            `).join('');
        }

        function updateThreatsList() {
            const container = document.getElementById('threatsList');
            const countBadge = document.getElementById('threatCountBadge');
            countBadge.textContent = state.threats.length;
            document.getElementById('statThreats').textContent = state.threats.length;
            
            if (state.threats.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">[OK]</div><div>No active threats</div></div>';
                return;
            }
            
            container.innerHTML = state.threats.slice(0, 5).map(threat => `
                <div class="threat-item ${threat.severity || 'medium'}">
                    <div class="threat-header">
                        <span class="threat-title">${threat.title || 'Unknown Threat'}</span>
                        <span class="threat-badge ${threat.severity || 'medium'}">${threat.severity || 'medium'}</span>
                    </div>
                    <div class="threat-description">${threat.description || ''}</div>
                </div>
            `).join('');
        }

        // Modals
        function closeModal() {
            document.getElementById('deviceModal').classList.remove('active');
        }

        function showPentestModal() {
            document.getElementById('pentestModal').classList.add('active');
        }

        function closePentestModal() {
            document.getElementById('pentestModal').classList.remove('active');
        }

        function selectDevice(ip) {
            state.selectedDevice = state.devices.find(d => d.ip === ip);
            if (state.selectedDevice) {
                document.getElementById('modalDeviceName').textContent = state.selectedDevice.hostname || state.selectedDevice.ip;
                document.getElementById('deviceModal').classList.add('active');
            }
        }

        // Tools Status
        async function refreshToolsStatus() {
            const container = document.getElementById('toolsStatusGrid');
            try {
                const response = await fetch('/api/pentest/tools');
                const data = await response.json();
                
                container.innerHTML = Object.entries(data.tools).map(([name, info]) => {
                    const cls = info.available ? 'available' : 'missing';
                    return `<span class="tool-badge ${cls}" title="${info.path || 'Not installed'}">${name}</span>`;
                }).join('') + `<span style="color: var(--text-muted); font-size: 0.7rem; margin-left: 0.5rem;">${data.available_count}/${data.total_count}</span>`;
            } catch (e) {
                container.innerHTML = '<span style="color: var(--danger); font-size: 0.8rem;">Failed to load</span>';
            }
        }

        // Pentest
        async function startPentest() {
            const targetUrl = document.getElementById('pentestTargetUrl').value;
            if (!targetUrl) {
                alert('Please enter a target URL');
                return;
            }
            
            closePentestModal();
            clearDebugLog();
            
            try {
                const response = await fetch('/api/pentest/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        target_url: targetUrl,
                        scope: document.getElementById('pentestScope').value,
                        enable_tools: document.getElementById('pentestTools').checked,
                        enable_exploitation: document.getElementById('pentestExploit').checked,
                        generate_report: document.getElementById('pentestReport').checked
                    })
                });
                
                const data = await response.json();
                if (data.session_id) {
                    state.pentestSessionId = data.session_id;
                    state.pentestRunning = true;
                    document.getElementById('pentestIdleState').style.display = 'none';
                    document.getElementById('pentestRunningState').style.display = 'block';
                    document.getElementById('pentestTarget').textContent = targetUrl;
                    document.getElementById('pentestStatusText').textContent = 'Running';
                    document.getElementById('pentestStatusBadge').querySelector('.status-dot').className = 'status-dot warning';
                    document.getElementById('debugLiveBadge').style.display = 'flex';
                    pollPentestStatus();
                }
            } catch (e) {
                appendDebugLog('error', 'Failed to start pentest: ' + e.message);
            }
        }

        async function cancelPentest() {
            if (state.pentestSessionId) {
                await fetch('/api/pentest/cancel', { method: 'POST' });
                state.pentestRunning = false;
                document.getElementById('pentestIdleState').style.display = 'block';
                document.getElementById('pentestRunningState').style.display = 'none';
                document.getElementById('pentestStatusText').textContent = 'Cancelled';
                document.getElementById('debugLiveBadge').style.display = 'none';
            }
        }

        async function pollPentestStatus() {
            if (!state.pentestRunning) return;
            
            try {
                const [statusRes, vulnsRes] = await Promise.all([
                    fetch('/api/pentest/status'),
                    fetch('/api/pentest/vulnerabilities')
                ]);
                
                const status = await statusRes.json();
                const vulns = await vulnsRes.json();
                
                updatePentestUI(status, vulns.vulnerabilities || []);
                
                if (status.status === 'running') {
                    setTimeout(pollPentestStatus, 2000);
                } else {
                    state.pentestRunning = false;
                    document.getElementById('debugLiveBadge').style.display = 'none';
                    if (status.status === 'completed') {
                        document.getElementById('pentestStatusText').textContent = 'Completed';
                        document.getElementById('pentestStatusBadge').querySelector('.status-dot').className = 'status-dot online';
                    }
                }
            } catch (e) {
                setTimeout(pollPentestStatus, 5000);
            }
        }

        function updatePentestUI(status, vulns) {
            document.getElementById('pentestProgress').textContent = Math.round(status.progress || 0) + '%';
            document.getElementById('pentestProgressBar').style.width = (status.progress || 0) + '%';
            document.getElementById('pentestVulnCount').textContent = vulns.length;
            document.getElementById('pentestVulnBadge').textContent = vulns.length;
            
            if (status.current_phase) {
                document.getElementById('pentestCurrentAgent').textContent = status.current_phase;
            }
            
            // Update vulnerability list
            const vulnContainer = document.getElementById('pentestVulnList');
            if (vulns.length === 0) {
                vulnContainer.innerHTML = '<div class="empty-state"><div class="empty-icon">[OK]</div><div>No vulnerabilities found yet</div></div>';
            } else {
                vulnContainer.innerHTML = vulns.map(v => `
                    <div class="threat-item ${v.severity || 'medium'}">
                        <div class="threat-header">
                            <span class="threat-title">${v.title || v.type}</span>
                            <span class="threat-badge ${v.severity || 'medium'}">${v.severity || 'medium'}</span>
                        </div>
                        <div class="threat-description">${v.description || v.endpoint || ''}</div>
                    </div>
                `).join('');
            }
        }

        // Debug Log
        function appendDebugLog(level, message) {
            const log = document.getElementById('pentestDebugLog');
            const levelClass = {
                phase: 'log-phase',
                agent: 'log-agent',
                llm: 'log-llm',
                http: 'log-http',
                vuln: 'log-vuln',
                success: 'log-success',
                error: 'log-error',
                warn: 'log-warn'
            }[level] || '';
            
            const time = new Date().toLocaleTimeString();
            const entry = `<span class="${levelClass}">[${time}] [${level.toUpperCase()}] ${message}</span>\n`;
            state.debugLogs.push({ time, level, message });
            log.innerHTML += entry;
            log.scrollTop = log.scrollHeight;
        }

        function clearDebugLog() {
            document.getElementById('pentestDebugLog').innerHTML = '<span style="color: var(--text-muted);">[Log cleared]</span>\n';
            state.debugLogs = [];
        }

        function downloadDebugLog() {
            const content = state.debugLogs.map(l => `[${l.time}] [${l.level}] ${l.message}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pentest-debug-${Date.now()}.log`;
            a.click();
        }

        function toggleDebugPanel() {
            const body = document.getElementById('pentestDebugBody');
            const icon = document.getElementById('debugToggleIcon');
            state.debugExpanded = !state.debugExpanded;
            body.style.display = state.debugExpanded ? 'block' : 'none';
            icon.textContent = state.debugExpanded ? '[-]' : '[+]';
        }

        // Topology
        function refreshTopology() {
            const canvas = document.getElementById('topology');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (state.devices.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('Scanning for devices...', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Draw devices
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(canvas.width, canvas.height) * 0.35;
            
            // Draw router at center
            ctx.fillStyle = '#f59e0b';
            ctx.beginPath();
            ctx.arc(centerX, centerY, 12, 0, Math.PI * 2);
            ctx.fill();
            
            // Draw devices around
            state.devices.forEach((device, i) => {
                const angle = (i / state.devices.length) * Math.PI * 2 - Math.PI / 2;
                const x = centerX + Math.cos(angle) * radius;
                const y = centerY + Math.sin(angle) * radius;
                
                // Line to center
                ctx.strokeStyle = '#1a1a1a';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.lineTo(x, y);
                ctx.stroke();
                
                // Device node
                ctx.fillStyle = '#3b82f6';
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // Label
                ctx.fillStyle = '#a0a0a0';
                ctx.font = '11px JetBrains Mono';
                ctx.textAlign = 'center';
                ctx.fillText(device.ip.split('.').pop(), x, y + 22);
            });
        }

        // Network scanning
        async function scanNetwork() {
            // Find the button that was clicked
            const btns = document.querySelectorAll('button');
            let btn = null;
            btns.forEach(b => { if (b.textContent.includes('Scan')) btn = b; });
            
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Scanning...';
            }
            
            console.log('Starting network scan...');
            
            try {
                const response = await fetch('/api/scan/network', { method: 'POST' });
                const data = await response.json();
                console.log('Scan result:', data);
                
                if (data.success) {
                    state.devices = data.devices || [];
                    updateDevicesList();
                    updateDevicesGrid();
                    refreshTopology();
                    document.getElementById('statDevices').textContent = state.devices.length;
                    console.log(`Found ${data.devices_found} devices`);
                } else {
                    console.error('Scan failed:', data.error);
                }
            } catch (e) {
                console.error('Scan error:', e);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Scan Network';
                }
            }
        }

        // Update the devices grid (Endpoints view)
        function updateDevicesGrid() {
            const grid = document.getElementById('devicesGrid');
            if (!grid) return;
            
            if (state.devices.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">[#]</div><div>No endpoints discovered yet</div><button class="btn btn-primary" style="margin-top: 1rem;" onclick="scanNetwork()">Scan Network</button></div>';
                return;
            }
            
            grid.innerHTML = state.devices.map(device => `
                <div class="device-card" onclick="selectDevice('${device.ip}')">
                    <div class="device-header">
                        <span class="device-name">${device.hostname || device.ip}</span>
                        <span class="device-type-badge ${device.type || ''}">${device.type || 'unknown'}</span>
                    </div>
                    <div class="device-ip" style="margin: 0.5rem 0;">${device.ip}</div>
                    <div style="font-size: 0.75rem; color: var(--text-muted);">
                        <div>MAC: ${device.mac || '-'}</div>
                        <div>Vendor: ${device.vendor || 'Unknown'}</div>
                        <div>Status: <span style="color: var(--success);">${device.status || 'online'}</span></div>
                    </div>
                </div>
            `).join('');
        }

        // Update network connections table
        function updateConnectionsTable() {
            const tbody = document.getElementById('connectionsTableBody');
            if (!tbody) return;
            
            if (state.connections.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: var(--text-muted); padding: 2rem;">No active connections</td></tr>';
                return;
            }
            
            tbody.innerHTML = state.connections.slice(0, 50).map(conn => `
                <tr>
                    <td style="color: var(--accent);">${conn.process || conn.name || '-'}</td>
                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">${conn.local || conn.local_addr || '-'}</td>
                    <td style="font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;">${conn.remote || conn.remote_addr || '-'}</td>
                    <td><span class="conn-state ${(conn.state || '').toLowerCase()}">${conn.state || conn.status || '-'}</span></td>
                    <td>${conn.protocol || conn.type || 'TCP'}</td>
                </tr>
            `).join('');
        }

        // Fetch network connections
        async function fetchConnections() {
            try {
                const response = await fetch('/api/connections');
                const data = await response.json();
                state.connections = data.connections || [];
                updateConnectionsList();
                updateConnectionsTable();
                document.getElementById('statConnections').textContent = state.connections.length;
            } catch (e) {
                console.error('Failed to fetch connections:', e);
            }
        }

        // Fetch all data
        async function fetchAllData() {
            try {
                const [devicesRes, connectionsRes, threatsRes, trafficRes] = await Promise.all([
                    fetch('/api/devices'),
                    fetch('/api/connections'),
                    fetch('/api/threats'),
                    fetch('/api/traffic')
                ]);
                
                const devices = await devicesRes.json();
                const connections = await connectionsRes.json();
                const threats = await threatsRes.json();
                const traffic = await trafficRes.json();
                
                state.devices = devices.devices || [];
                state.connections = connections.connections || [];
                state.threats = threats.threats || [];
                
                updateDevicesList();
                updateDevicesGrid();
                updateConnectionsList();
                updateConnectionsTable();
                updateThreatsList();
                refreshTopology();
                
                // Update stats
                document.getElementById('statDevices').textContent = state.devices.length;
                document.getElementById('statConnections').textContent = state.connections.length;
                document.getElementById('statThreats').textContent = state.threats.length;
                
                if (traffic.bytes_in !== undefined) {
                    document.getElementById('statTrafficIn').textContent = formatBytes(traffic.bytes_in);
                    document.getElementById('statTrafficOut').textContent = formatBytes(traffic.bytes_out);
                }
            } catch (e) {
                console.error('Failed to fetch data:', e);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function exportDevices() {
            const csv = 'IP,MAC,Hostname,Type,Vendor,Status\n' + 
                state.devices.map(d => `${d.ip},${d.mac},${d.hostname},${d.type},${d.vendor},${d.status}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'endpoints.csv';
            a.click();
        }
        
        function exportTraffic() {
            const csv = 'Process,Local,Remote,State,Protocol\n' + 
                state.connections.map(c => `${c.process || c.name},${c.local || c.local_addr},${c.remote || c.remote_addr},${c.state},${c.protocol || 'TCP'}`).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'connections.csv';
            a.click();
        }
        
        function clearConnections() { state.connections = []; updateConnectionsList(); updateConnectionsTable(); }
        function dismissAllThreats() { state.threats = []; updateThreatsList(); }
        function remediateAll() { console.log('Remediate all'); }
        
        // ========== FILE SCANNER ==========
        async function startScan() {
            const scanPath = document.getElementById('scanPath').value || 'C:\\Users';
            const deepScan = document.getElementById('scanDeep')?.checked || false;
            const aiAnalysis = document.getElementById('scanAI')?.checked || true;
            const recursive = document.getElementById('scanRecursive')?.checked || true;
            
            const statusEl = document.getElementById('scanStatus');
            const resultsEl = document.getElementById('scanResults');
            
            statusEl.textContent = 'Scanning...';
            statusEl.style.color = 'var(--warning)';
            resultsEl.innerHTML = '<div class="empty-state"><div class="empty-icon">[...]</div><div>Scanning files...</div></div>';
            
            try {
                const response = await fetch('/api/scan/files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        path: scanPath,
                        deep: deepScan,
                        ai_analysis: aiAnalysis,
                        recursive: recursive
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusEl.textContent = `Complete - ${data.files_scanned} files, ${data.threats_found} threats`;
                    statusEl.style.color = data.threats_found > 0 ? 'var(--danger)' : 'var(--success)';
                    
                    if (data.results.length === 0) {
                        resultsEl.innerHTML = '<div class="empty-state"><div class="empty-icon">[OK]</div><div>No files scanned</div></div>';
                    } else {
                        const threatResults = data.results.filter(r => r.status !== 'clean');
                        if (threatResults.length === 0) {
                            resultsEl.innerHTML = `<div class="empty-state"><div class="empty-icon">[OK]</div><div>All ${data.files_scanned} files clean</div></div>`;
                        } else {
                            resultsEl.innerHTML = threatResults.map(r => `
                                <div class="threat-item ${r.severity || 'medium'}">
                                    <div class="threat-header">
                                        <span class="threat-title">${r.file.split('\\\\').pop()}</span>
                                        <span class="threat-badge ${r.severity || 'medium'}">${r.status}</span>
                                    </div>
                                    <div class="threat-description">${r.details || r.threat_type || ''}</div>
                                    <div style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem;">${r.file}</div>
                                </div>
                            `).join('');
                        }
                    }
                    
                    // Refresh threats list
                    fetchAllData();
                } else {
                    statusEl.textContent = 'Error';
                    statusEl.style.color = 'var(--danger)';
                    resultsEl.innerHTML = `<div class="empty-state"><div class="empty-icon">[!]</div><div>Scan failed: ${data.detail || 'Unknown error'}</div></div>`;
                }
            } catch (e) {
                statusEl.textContent = 'Error';
                statusEl.style.color = 'var(--danger)';
                resultsEl.innerHTML = `<div class="empty-state"><div class="empty-icon">[!]</div><div>Scan failed: ${e.message}</div></div>`;
            }
        }
        
        function viewHistory() { console.log('View history'); }
        function rollbackLast() { console.log('Rollback last'); }
        function viewPentestHistory() { console.log('Pentest history'); }
        function importRules() { console.log('Import rules'); }
        function generateRule() { console.log('Generate rule'); }
        
        // ========== SETTINGS PERSISTENCE ==========
        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                // Apply settings to form elements
                if (document.getElementById('settingsProvider')) {
                    document.getElementById('settingsProvider').value = settings.provider || 'ollama';
                }
                if (document.getElementById('settingsModel')) {
                    document.getElementById('settingsModel').value = settings.model || 'deepseek-r1:70b';
                }
                if (document.getElementById('settingsScanInterval')) {
                    document.getElementById('settingsScanInterval').value = settings.scan_interval || 60;
                }
                if (document.getElementById('settingsNetworkRange')) {
                    document.getElementById('settingsNetworkRange').value = settings.network_range || '192.168.4.0/24';
                }
                if (document.getElementById('settingsAutoQuarantine')) {
                    document.getElementById('settingsAutoQuarantine').checked = settings.auto_quarantine || false;
                }
                if (document.getElementById('settingsDoubleVerify')) {
                    document.getElementById('settingsDoubleVerify').checked = settings.double_verify !== false;
                }
                if (document.getElementById('settingsRequireApproval')) {
                    document.getElementById('settingsRequireApproval').checked = settings.require_approval !== false;
                }
                if (document.getElementById('scanPath')) {
                    document.getElementById('scanPath').value = settings.scan_path || 'C:\\Users';
                }
                
                // Update model display in header
                if (document.getElementById('modelName')) {
                    document.getElementById('modelName').textContent = settings.model || 'deepseek-r1:70b';
                }
                
                console.log('Settings loaded:', settings);
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }
        
        async function saveSettings() {
            const settings = {
                provider: document.getElementById('settingsProvider')?.value || 'ollama',
                model: document.getElementById('settingsModel')?.value || 'deepseek-r1:70b',
                scan_interval: parseInt(document.getElementById('settingsScanInterval')?.value) || 60,
                network_range: document.getElementById('settingsNetworkRange')?.value || '192.168.4.0/24',
                auto_quarantine: document.getElementById('settingsAutoQuarantine')?.checked || false,
                double_verify: document.getElementById('settingsDoubleVerify')?.checked !== false,
                require_approval: document.getElementById('settingsRequireApproval')?.checked !== false,
                scan_path: document.getElementById('scanPath')?.value || 'C:\\Users',
            };
            
            try {
                const response = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Update header display
                    if (document.getElementById('modelName')) {
                        document.getElementById('modelName').textContent = settings.model;
                    }
                    
                    alert('Settings saved successfully!');
                    console.log('Settings saved:', data.settings);
                } else {
                    alert('Failed to save settings');
                }
            } catch (e) {
                console.error('Failed to save settings:', e);
                alert('Error saving settings: ' + e.message);
            }
        }
        
        function analyzeDevice() { console.log('Analyze device'); }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            console.log('Artemis Dashboard initializing...');
            
            connectWS();
            refreshTopology();
            refreshToolsStatus();
            
            // Load persisted settings
            loadSettings();
            
            // Initial data fetch
            fetchAllData();
            
            // Auto-scan network on first load
            setTimeout(() => {
                console.log('Auto-scanning network...');
                scanNetwork();
            }, 1000);
            
            window.addEventListener('resize', refreshTopology);
            
            // Poll for updates every 10 seconds (includes traffic stats)
            setInterval(fetchAllData, 10000);
            
            // Poll connections more frequently
            setInterval(fetchConnections, 5000);
            
            // Run AI analysis periodically (every 60 seconds)
            setInterval(runAutoAIAnalysis, 60000);
        });
        
        // ========== AUTO AI ANALYSIS ==========
        async function runAutoAIAnalysis() {
            // Only run if we have connections and devices
            if (state.connections.length === 0 && state.devices.length === 0) {
                return;
            }
            
            try {
                // Analyze unusual connection patterns
                const suspiciousConns = state.connections.filter(conn => {
                    // Check for unusual ports
                    const remote = conn.remote || '';
                    const port = remote.split(':').pop();
                    const suspiciousPorts = ['4444', '5555', '6666', '1337', '31337', '8888', '9999'];
                    return suspiciousPorts.includes(port);
                });
                
                if (suspiciousConns.length > 0) {
                    // Add to AI analysis feed
                    const aiList = document.getElementById('aiList');
                    const analysisHtml = `
                        <div class="ai-panel" style="margin: 0.375rem;">
                            <div class="ai-header">Suspicious Connection Detected</div>
                            <div class="ai-response">Found ${suspiciousConns.length} connection(s) to unusual ports. Processes: ${suspiciousConns.map(c => c.process || 'unknown').join(', ')}</div>
                        </div>
                    `;
                    
                    if (aiList.querySelector('.empty-state')) {
                        aiList.innerHTML = '';
                    }
                    aiList.insertAdjacentHTML('afterbegin', analysisHtml);
                    
                    document.getElementById('statAnalyses').textContent = parseInt(document.getElementById('statAnalyses').textContent || 0) + 1;
                }
                
                // Check for new devices (potential rogue devices)
                const recentDevices = state.devices.filter(d => {
                    // Devices seen in last 5 minutes
                    const lastSeen = new Date(d.last_seen);
                    const now = new Date();
                    return (now - lastSeen) < 5 * 60 * 1000;
                });
                
                if (recentDevices.length > 5) {
                    // Many new devices - possible network scan
                    console.log('AI Analysis: Multiple new devices detected');
                }
                
            } catch (e) {
                console.error('AI analysis error:', e);
            }
        }
    </script>
</body>
</html>
